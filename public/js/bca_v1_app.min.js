/*! Built for bca_v1 2013-12-04 */
var ALL;ALL=function(){function a(){}return a.prototype.model={dummy:null},a.prototype.init=function(){var a;return a=this,BCA.db_uploads=new Firebase("https://bca.firebaseIO.com/uploads"),BCA.db_uploads.once("value",function(b){var c,d,e,f,g,h;f=b.val(),e=[];for(c in f){g=f[c];for(d in g)h=g[d],h.id=c,e.push(h)}return e.sort(function(a,b){return b.time-a.time}),BCA.ui.render_rewrite(null,"page_all",a.model,function(){return BCA.ui.render_rewrite("all_posts","module_post",{posts:e,allow_delete:!1,show_time:!1},function(){})})}),this},a}();var FEED;FEED=function(){function a(){}return a.prototype.model={dummy:"",fb_user:null,today:"",posts_array:null,has_access:!1},a.prototype.bind_submit_image=function(){return BCA.ui.make_jq_img_upload("jq_image_upload","image_upload_wrapper","image_upload_progress",function(a){return BCA.db_uploads.child(BCA.fb_user.id).push({url:a,time:new Date-0,reflect:"",note:""})})},a.prototype.bind_submit_reflection=function(){var a;return a=this,$("#submit_reflection").click(function(){var a;return a=$("#my_reflection").val().trim(),a.length<10?alert("Your relection is too short!"):BCA.db_uploads.child(BCA.fb_user.id).push({url:"",time:new Date-0,reflect:a,note:""})})},a.prototype.render_cal=function(a){var b;return a||(a=b.get_current_month()),b=this,$("#calendar").html(BCA.ui.make_cal(a-1)),BCA.ui.schedule(function(){var c,d,e,f,g,h,i,j,k;for(12===a&&$(".next_month").hide(),1===a&&$(".prev_month").hide(),$(".prev_month").unbind().click(function(){return b.render_cal(a-1)}),$(".next_month").unbind().click(function(){return b.render_cal(a+1)}),e=0,f="",k=b.model.posts_array,g=i=0,j=k.length;j>i;g=++i)h=k[g],""!==h.url?(d=parseInt(h.time.split("/")[1].trim()),c=parseInt(h.time.split("/")[2].trim())+e,$(".d_"+d+"_"+c+" div").css("background-image","url("+h.url+")"),$(".d_"+d+"_"+c).data("idx",g)):(d=parseInt(h.time.split("/")[1].trim()),c=parseInt(h.time.split("/")[2].trim())+e,$(".d_"+d+"_"+c+" div").text(h.reflect),$(".d_"+d+"_"+c).data("idx",g)),f=".d_"+d+"_"+c,e+=1;return 0===b.model.posts_array.length&&$("#preview").html("<div style='text-align:center;padding-top:100px'>No activity uploaded.</div>"),$(".c_date").unbind().click(function(){return g=$(this).data("idx"),"undefined"!=typeof g?BCA.ui.render_rewrite("preview","module_post",{posts:[b.model.posts_array[g]],allow_delete:!1,show_time:!0},function(){}):void 0}),$(""+f).trigger("click")})},a.prototype.get_date=function(a){var b,c,d,e;return b=new Date(a),d=b.getUTCMonth()+1,c=b.getUTCDate()-1,e=b.getUTCFullYear(),e+" / "+d+" / "+c},a.prototype.get_current_month=function(){var a,b;return b=this,a=new Date,a.getUTCMonth()+1},a.prototype.render_previous_activity=function(a){var b;return b=this,BCA.db_user_uploads=new Firebase("https://bca.firebaseIO.com/uploads/"+BCA.fb_user.id),BCA.db_user_uploads.on("value",function(c){var d,e,f,g,h;g=c.val(),f=[];for(e in g)h=g[e],h.time=b.get_date(h.time),h.id=e,f.push(h);return f=f.reverse(),a&&f.length>=3&&""!==f[0].url&&""!==f[1].url&&""!==f[2].url?($("#image_upload_wrapper_bg").hide(),$("#reflection_wrapper_bg").show(),$("#done_today").hide(),$("#reflection_wrapper textarea").focus()):a?($("#image_upload_wrapper_bg").show(),$("#reflection_wrapper_bg").hide(),$("#done_today").hide()):($("#image_upload_wrapper_bg").hide(),$("#reflection_wrapper_bg").hide(),$("#done_today").hide()),b.model.posts_array=f,d=!1,a&&(d=!0),BCA.ui.render_rewrite("previous_activities","module_post",{posts:f,allow_delete:d,show_time:!0},function(){return $(".trash_post").unbind().click(function(a){return confirm("Are you sure to delete this post?")?BCA.db_user_uploads.child($(a.target).data("id")).remove():void 0}),b.render_cal(b.get_current_month())})})},a.prototype.render_views=function(a){var b;return b=this,b.model.has_access=a,BCA.ui.render_rewrite(null,"page_feed",b.model,function(){return a&&(b.bind_submit_reflection(),b.bind_submit_image()),b.render_previous_activity(a)})},a.prototype.init=function(a){var b,c;return b=this,b.model.today=b.get_date(new Date),a?(c=new Firebase("https://bca.firebaseIO.com/users/"+a),c.once("value",function(c){var d;return BCA.fb_user=c.val(),d=new Firebase("https://bca.firebaseIO.com/tasks/"+a),d.once("value",function(a){return BCA.fb_user.task=a.val().goal,b.model.fb_user=BCA.fb_user,b.render_views(!1)})})):BCA.db_user_tasks&&BCA.fb_user?(b.model.fb_user=BCA.fb_user,b.render_views(!0)):(BCA.rt.route_to(""),void 0)},a}();var HOME;HOME=function(){function a(){}return a.prototype.model={dummy:""},a.prototype.auth_and_setup=function(){var a;return a=this,BCA.auth=new FirebaseSimpleLogin(BCA.db,function(a,b){return $("#login_panel").fadeIn("fast"),a?console.log(a.message):b?($("#login_button").hide(),$("#logout_button").show(),$("#restart_button").hide(),BCA.fb_user=b,BCA.db_users.child(b.id).set(b),console.log("User ID: "+b.id+", Provider: "+b.provider),BCA.db_user_tasks=new Firebase("https://bca.firebaseIO.com/tasks/"+b.id),BCA.db_user_tasks.once("value",function(a){return a.val()?($("#restart_button").show(),BCA.fb_user.task=a.val().goal,BCA.rt.route_to("feed")):BCA.rt.route_to("setup")})):(BCA.fb_user=null,$("#login_button").show(),$("#logout_button").hide(),$("#restart_button").hide(),console.log("user is logged out"))})},a.prototype.init=function(){var a;return a=this,BCA.ui.render_rewrite(null,"page_home",a.model,function(){return a.auth_and_setup()}),this},a}();var SETUP;SETUP=function(){function a(){}return a.prototype.model={dummy:"",preset_tasks:["Take a different path to work/school","Try a different food everyday","Take a picture of one single object"]},a.prototype.init=function(){var a;return a=this,$("#restart_button").hide(),BCA.db_user_tasks&&BCA.fb_user?BCA.ui.render_rewrite(null,"page_setup",a.model,function(){return $("#setup_button").unbind().click(function(){var a,b;return b=$("#my_own_task").val().trim(),b.length<5?alert("Your own task is too short!"):(a=b,BCA.db_user_tasks.set({goal:a,type:"self"},function(){return BCA.fb_user.task=a,$("#restart_button").show(),BCA.rt.route_to("feed")}))}),$(".preset_task").unbind().click(function(a){var b;return b=$(a.target).text(),BCA.db_user_tasks.set({goal:b,type:"pre_set"},function(){return BCA.fb_user.task=b,$("#restart_button").show(),BCA.rt.route_to("feed")})})}):(BCA.rt.route_to(""),void 0)},a}();